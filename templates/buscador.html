<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador - BigData</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- Estilos personalizados -->
    <style>
        :root {
            --azul: #1F42AD;
            --dorado: #EFB810;
            --azul-oscuro: #162F7A;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f7fa;
        }

        .navbar-custom {
            background-color: var(--azul);
            padding: 1rem 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }

        .navbar-brand {
            font-size: 1.6rem;
            font-weight: 700;
            color: white !important;
        }

        .nav-link {
            color: #e5e9ff !important;
            font-weight: 500;
        }

        .nav-link:hover,
        .nav-link.active {
            color: var(--dorado) !important;
            font-weight: 700;
        }

        .card {
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .btn-primary {
            background-color: var(--azul) !important;
            border-color: var(--azul) !important;
        }

        .btn-primary:hover {
            background-color: var(--azul-oscuro) !important;
            border-color: var(--azul-oscuro) !important;
        }

        .aggs-list {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            height: 600px;
            overflow-y: auto;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.05);
        }

        .json-view {
            background: #eef2ff;
            padding: 8px;
            border-left: 4px solid var(--azul);
            border-radius: 6px;
            font-size: 0.75rem;
        }

        footer {
            background-color: var(--azul);
            color: white;
            padding: 25px 0;
            margin-top: 80px;
        }
    </style>
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container">
        <a class="navbar-brand" href="/">BigData – MiProyecto</a>
        <ul class="navbar-nav ms-auto">
            <li class="nav-item"><a class="nav-link" href="/">Inicio</a></li>
            <li class="nav-item"><a class="nav-link active" href="/buscador">Buscador</a></li>
            <li class="nav-item"><a class="nav-link" href="/about">Acerca de</a></li>
            <li class="nav-item"><a class="nav-link" href="/login">Ingresar</a></li>
        </ul>
    </div>
</nav>

<div class="container mt-4">
    <h1 class="text-center mb-4" style="color: var(--azul); font-weight: 700;">
        Buscador de documentos
    </h1>

    <!-- FORMULARIO -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="formBuscar" onsubmit="buscar(event)">
                <div class="row g-3 align-items-end">
                    <div class="col-md-10">
                        <label class="form-label">Texto a buscar</label>
                        <input type="text" class="form-control" id="textoBuscar"
                            placeholder="Ingrese texto..." required>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">Buscar</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- LOADING -->
    <div id="div_cargando" class="text-center mt-4" style="display: none;">
        <div class="spinner-border text-primary"></div>
        <p class="mt-2">Buscando documentos...</p>
    </div>

    <!-- RESULTADOS -->
    <div id="divResultados" class="resultados-container" style="display: none;">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0">Resultados — Total: <span id="totalResultados">0</span></h5>
            </div>

            <div class="card-body">
                <div class="row">

                    <!-- Aggregations -->
                    <div class="col-md-3">
                        <div class="aggs-list">
                            <h6>Filtros</h6>
                            <h6 class="mt-3">Agregaciones</h6>
                            <div id="divAggregations"></div>
                        </div>
                    </div>

                    <!-- TABLA -->
                    <div class="col-md-9">
                        <table class="table table-striped table-bordered table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>ID</th>
                                    <th>Score</th>
                                    <th>Índice</th>
                                    <th>Páginas</th>
                                    <th>Caracteres</th>
                                    <th>Procesado</th>
                                    <th>Contenido</th>
                                </tr>
                            </thead>
                            <tbody id="tablaResultados"></tbody>
                        </table>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- ERROR -->
    <div id="divError" class="alert alert-danger mt-4" style="display:none;">
        <strong>Error:</strong> <span id="mensajeError"></span>
    </div>
</div>

<footer class="text-center">
    <p>Creado por {{ creador }}</p>
    <p id="current-year"></p>
    <p>Versión: {{ version }}</p>
</footer>

<script>
document.getElementById("current-year").innerText = new Date().getFullYear();
</script>

<!-- ========================================================= -->
<!-- SCRIPT COMPLETO CON TUS CAMBIOS DE COLUMNAS -->
<!-- ========================================================= -->

<script>

let ultimaBusqueda = [];

/* ============================
Ejecutar búsqueda
============================ */
function buscar(event) {
    event.preventDefault();
    
    const textoBuscar = document.getElementById('textoBuscar').value.trim();
    if (!textoBuscar) return;

    document.getElementById('divResultados').style.display = 'none';
    document.getElementById('divError').style.display = 'none';
    document.getElementById('div_cargando').style.display = 'block';

    fetch('/buscar-elastic', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ texto: textoBuscar })
    })
    .then(r => r.json())
    .then(data => {
        document.getElementById('div_cargando').style.display = 'none';

        if (data.success) {
            document.getElementById('totalResultados').textContent = data.total;
            mostrarHits(data.resultados || []);
            document.getElementById('divResultados').style.display = 'block';
        } else {
            mostrarError(data.error);
        }
    })
    .catch(() => mostrarError("Error al buscar"));
}

/* ============================
Mostrar tabla de resultados
============================ */
function mostrarHits(hits) {
    ultimaBusqueda = hits;
    const tabla = document.getElementById("tablaResultados");
    tabla.innerHTML = "";

    if (!hits.length) {
        tabla.innerHTML = `<tr><td colspan="8" class="text-center">Sin resultados</td></tr>`;
        return;
    }

    hits.forEach((hit, i) => {
        const s = hit._source || {};

        const paginas = s.num_paginas ?? "N/A";
        const caracteres = s.caracteres ?? "N/A";
        const fecha = s.fecha_procesado ?? "N/A";

        let texto = s.contenido || s.texto_ocr || s.texto || JSON.stringify(s);
        let resumen = texto.substring(0, 200) + (texto.length > 200 ? "..." : "");

        const fila = `
            <tr>
                <td>${i + 1}</td>
                <td>${hit._id}</td>
                <td>${hit._score?.toFixed(4) ?? "N/A"}</td>
                <td>${hit._index}</td>
                <td>${paginas}</td>
                <td>${caracteres}</td>
                <td>${fecha}</td>
                <td>
                    <div class="json-view">${resumen}</div>
                    <button class="btn btn-sm btn-link mt-1"
                            onclick="mostrarDetalle(${i})"
                            data-bs-toggle="modal"
                            data-bs-target="#modalDetalle">
                        Ver completo
                    </button>
                </td>
            </tr>
        `;

        tabla.insertAdjacentHTML("beforeend", fila);
    });
}

/* ============================
Mostrar error
============================ */
function mostrarError(msg) {
    document.getElementById("mensajeError").innerText = msg;
    document.getElementById("divError").style.display = "block";
}

/* ============================
Mostrar modal detalle
============================ */
function mostrarDetalle(i) {
    const s = ultimaBusqueda[i]._source;
    document.getElementById("modalDetalleBody").innerHTML =
        `<pre class="json-view">${JSON.stringify(s, null, 2)}</pre>`;
}

</script>

<!-- ============================
    MODAL
============================ -->
<div class="modal fade" id="modalDetalle">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Detalle del documento</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalDetalleBody"></div>
        </div>
    </div>
</div>

</body>
</html>
